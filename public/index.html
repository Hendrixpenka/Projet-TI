<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Atlas des Productions - Cameroun</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1e4d2b; --accent: #fcd116; --danger: #ce1126; --bg: #f4f7f6; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; height: 100vh; background: var(--bg); }
        
        /* Sidebar avec dégradé subtil */
        #sidebar { 
            width: 360px; background: white; padding: 25px; 
            display: flex; flex-direction: column; 
            box-shadow: 5px 0 15px rgba(0,0,0,0.1); z-index: 1000;
        }
        h2 { color: var(--primary); border-left: 5px solid var(--danger); padding-left: 10px; margin-bottom: 30px; font-size: 1.4rem; }
        
        .filter-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.85rem; color: #555; }
        select { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; 
            background: #fff; font-size: 1rem; cursor: pointer; outline: none;
        }
        select:focus { border-color: var(--primary); }
        select:disabled { background: #f9f9f9; cursor: not-allowed; }

        #map { flex-grow: 1; }

        /* Légende */
        .legend { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.2); line-height: 25px; }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; border-radius: 3px; }

        /* Modals */
        .modal { 
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; 
            width: 100%; height: 100%; background: rgba(0,0,0,0.5); 
            align-items: center; justify-content: center; 
        }
        .modal-content { 
            background: white; padding: 30px; border-radius: 12px; width: 80%; max-width: 600px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; }
        .btn-close { background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; float: right; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Productions CMR</h2>
    
    <div class="filter-group">
        <label>FILIÈRE</label>
        <select id="filiere-filter"><option value="Tous">Toutes les filières</option></select>
    </div>

    <div class="filter-group">
        <label>BASSIN DE PRODUCTION (PRODUIT)</label>
        <select id="bassin-filter"><option value="Tous">Tous les produits</option></select>
    </div>

    <div class="filter-group">
        <label>RÉGION</label>
        <select id="region-filter"><option value="">Tout le Cameroun</option></select>
    </div>

    <div class="filter-group">
        <label>DÉPARTEMENT</label>
        <select id="department-filter" disabled><option value="">Sélectionnez une région...</option></select>
    </div>

    <div class="filter-group">
        <label>COMMUNE</label>
        <select id="commune-filter" disabled><option value="">Sélectionnez un département...</option></select>
    </div>

    <div class="filter-group">
        <label>TYPE DE VUE</label>
        <div class="view-switcher">
            <label><input type="radio" name="view-type" value="symbols" checked> Symboles</label>
            <label><input type="radio" name="view-type" value="heatmap"> Carte de chaleur</label>
        </div>
    </div>

    <p style="margin-top:auto; font-size: 0.8rem; color: #888; text-align: center;"> 2024 Cartographie des Bassins de Production du Cameroun</p>
</div>

<div id="map"></div>

<div id="details-modal" class="modal">
    <div class="modal-content">
        <h3 id="modal-title">Détails</h3>
        <div id="modal-body">
            <canvas id="production-chart"></canvas>
        </div>
        <button class="btn-close" onclick="closeModal()">Fermer</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script>
    // 1. INITIALISATION DE LA CARTE (LIMITES CAMEROUN)
    const cmrBounds = [[1.5, 8.2], [13.2, 16.5]];
    const map = L.map('map', {
        maxBounds: cmrBounds,
        maxBoundsViscosity: 1.0
    }).setView([7.36, 12.35], 6);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // 2. VARIABLES
    let currentLayer = null;
    let productions = [];
    let viewType = 'symbols'; // 'symbols' or 'heatmap'
    let heatLayer = null;
    let basinColors = {};
    const colorPalette = ['#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9A6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#a9a9a9'];

    function getColor(bassin) {
        if (!bassin || bassin === 'Aucun') return '#95a5a6';
        if (!basinColors[bassin]) {
            basinColors[bassin] = colorPalette[Object.keys(basinColors).length % colorPalette.length];
        }
        return basinColors[bassin];
    }

    // 3. NOUVELLE GESTION D'ÉTAT ET LOGIQUE DE MISE À JOUR
    const filters = {
        filiere: 'Tous',
        bassin: 'Tous',
        region: '',
        department: ''
    };

    const selectors = {
        filiere: document.getElementById('filiere-filter'),
        bassin: document.getElementById('bassin-filter'),
        region: document.getElementById('region-filter'),
        department: document.getElementById('department-filter'),
        commune: document.getElementById('commune-filter')
    };

    async function updateMap() {
        const params = new URLSearchParams({
            filiere: filters.filiere,
            bassin: filters.bassin
        });

        if (viewType === 'symbols') {
            heatLayer.setLatLngs([]);
            if (!map.hasLayer(symbolLayer)) symbolLayer.addTo(map);
            if (currentLayer && !map.hasLayer(currentLayer)) currentLayer.addTo(map);

            let endpoint = '/api/regions';
            if (filters.department) {
                endpoint = '/api/communes';
                params.append('department_pcode', filters.department);
            } else if (filters.region) {
                endpoint = '/api/departments';
                params.append('region_pcode', filters.region);
            }
            const data = await fetch(`${endpoint}?${params.toString()}`).then(r => r.json());
            displayLayer(data);
        } else { // heatmap
            symbolLayer.clearLayers();
            if (currentLayer) map.removeLayer(currentLayer);
            currentLayer = null;

            if (filters.department) {
                params.append('department_pcode', filters.department);
            } else if (filters.region) {
                params.append('region_pcode', filters.region);
            }
            await updateHeatmap(params);
        }
    }

    async function updateHeatmap(params) {
        const data = await fetch(`/api/heatmap?${params.toString()}`).then(r => r.json());
        heatLayer.setLatLngs(data);
    }

    async function populateDropdowns() {
        const [filieres, bassins, regionsData] = await Promise.all([
            fetch('/api/filieres').then(r => r.json()),
            fetch('/api/bassins').then(r => r.json()),
            fetch('/api/regions').then(r => r.json())
        ]);

        filieres.forEach(f => selectors.filiere.add(new Option(f, f)));
        bassins.forEach(b => selectors.bassin.add(new Option(b, b)));
        regionsData.features.forEach(reg => selectors.region.add(new Option(reg.properties.adm1_name1, reg.properties.adm1_pcode)));
    }

    async function updateBassinFilter(filiere) {
        const params = new URLSearchParams({ filiere: filiere });
        const bassins = await fetch(`/api/bassins?${params.toString()}`).then(r => r.json());
        
        selectors.bassin.innerHTML = '<option value="Tous">Tous les produits</option>';
        bassins.forEach(b => selectors.bassin.add(new Option(b, b)));
    }

    async function init() {
        productions = await fetch('/api/productions').then(r => r.json());
        await populateDropdowns();
        await updateMap(); // Premier affichage
    }

    let symbolLayer = L.layerGroup().addTo(map);
    heatLayer = L.heatLayer([], { radius: 25 }).addTo(map);

    function displayLayer(data) {
        if (currentLayer) map.removeLayer(currentLayer);
        symbolLayer.clearLayers();

        currentLayer = L.geoJSON(data, {
            style: () => ({ fillColor: 'transparent', weight: 1, color: '#333' })
        }).addTo(map);

        data.features.forEach(feature => {
            const productions = feature.properties.productions || [];
            const bounds = L.geoJSON(feature).getBounds();

            let filteredProductions = productions;
            if (filters.filiere !== 'Tous') {
                filteredProductions = filteredProductions.filter(p => p.filiere === filters.filiere);
            }
            if (filters.bassin !== 'Tous') {
                filteredProductions = filteredProductions.filter(p => p.produit === filters.bassin);
            }

            const totalQuantite = filteredProductions.reduce((sum, p) => sum + p.quantite, 0);
            if (totalQuantite === 0) return;

            filteredProductions.forEach(prod => {
                const symbolCount = Math.ceil((prod.quantite / totalQuantite) * 50); // Max 50 symboles par zone
                for (let i = 0; i < symbolCount; i++) {
                    const lat = bounds.getSouth() + Math.random() * (bounds.getNorth() - bounds.getSouth());
                    const lng = bounds.getWest() + Math.random() * (bounds.getEast() - bounds.getWest());
                    
                    L.circleMarker([lat, lng], {
                        radius: 3,
                        fillColor: getColor(prod.produit),
                        color: '#fff',
                        weight: 0.5,
                        fillOpacity: 0.8
                    }).bindTooltip(prod.produit).addTo(symbolLayer);
                }
            });
        });

        if(data.features.length > 0) map.fitBounds(currentLayer.getBounds());
        updateLegend();
    }

    document.querySelectorAll('input[name="view-type"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            viewType = e.target.value;
            updateMap();
        });
    });

    // 5. GESTION DES FILTRES (REFACTORISÉE)
    selectors.filiere.addEventListener('change', async (e) => {
        filters.filiere = e.target.value;
        filters.bassin = 'Tous'; // Réinitialiser le filtre de bassin
        await updateBassinFilter(filters.filiere);
        updateMap();
    });

    selectors.bassin.addEventListener('change', (e) => {
        filters.bassin = e.target.value;
        updateMap();
    });

    selectors.region.addEventListener('change', async (e) => {
        filters.region = e.target.value;
        filters.department = ''; // Réinitialiser

        // Vider et désactiver les listes dépendantes
        selectors.department.innerHTML = '<option value="">Tous les départements</option>';
        selectors.commune.innerHTML = '<option value="">Toutes les communes</option>';
        selectors.department.disabled = true;
        selectors.commune.disabled = true;

        if (filters.region) {
            const params = new URLSearchParams({ region_pcode: filters.region, filiere: filters.filiere, bassin: filters.bassin });
            const data = await fetch(`/api/departments?${params.toString()}`).then(r => r.json());
            data.features.forEach(d => selectors.department.add(new Option(d.properties.adm2_name1, d.properties.adm2_pcode)));
            selectors.department.disabled = false;
        }
        
        updateMap();
    });

    selectors.department.addEventListener('change', async (e) => {
        filters.department = e.target.value;

        selectors.commune.innerHTML = '<option value="">Toutes les communes</option>';
        selectors.commune.disabled = true;

        if (filters.department) {
            const params = new URLSearchParams({ department_pcode: filters.department, filiere: filters.filiere, bassin: filters.bassin });
            const data = await fetch(`/api/communes?${params.toString()}`).then(r => r.json());
            data.features.forEach(c => selectors.commune.add(new Option(c.properties.adm3_name1, c.properties.adm3_pcode)));
            selectors.commune.disabled = false;
        }

        updateMap();
    });

    selectors.commune.addEventListener('change', (e) => {
        // Optionnel : zoom sur la commune si sélectionnée
        const pcode = e.target.value;
        if (pcode) {
            const layerToZoom = Object.values(currentLayer._layers).find(l => l.feature.properties.adm3_pcode === pcode);
            if(layerToZoom) map.fitBounds(layerToZoom.getBounds());
        }
    });

    // 6. MODAL INFOS
    let productionChart = null;

    function showInfo(props) {
        const name = props.adm3_name1 || props.adm2_name1 || props.adm1_name1;
        document.getElementById('modal-title').innerText = `Productions : ${name}`;
        
        const prodsToShow = (props.productions || []).sort((a, b) => b.quantite - a.quantite);

        const modalBody = document.getElementById('modal-body');
        const canvas = document.getElementById('production-chart');

        if (productionChart) {
            productionChart.destroy();
        }

        if (prodsToShow.length > 0) {
            const labels = prodsToShow.map(p => p.produit);
            const data = prodsToShow.map(p => p.quantite);
            const backgroundColors = prodsToShow.map(p => getColor(p.produit));

            productionChart = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Production (Tonnes)',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            modalBody.style.display = 'block';
        } else {
            modalBody.innerHTML = '<p>Aucune donnée de production disponible pour cette zone.</p>';
        }

        document.getElementById('details-modal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('details-modal').style.display = 'none'; }

    // Légende
    let legend = L.control({position: 'bottomright'});
    legend.onAdd = function() {
        return L.DomUtil.create('div', 'legend');
    };
    legend.addTo(map);

    function updateLegend() {
        const legendDiv = document.querySelector('.legend');
        const displayedBassins = new Set();
        
        symbolLayer.eachLayer(layer => {
            const bassin = layer.getTooltip().getContent();
            if(bassin) displayedBassins.add(bassin);
        });

        let html = '<strong>Bassins de Production</strong><br>';
        Array.from(displayedBassins).sort().forEach(bassin => {
            html += `<i style="background:${getColor(bassin)}"></i> ${bassin}<br>`;
        });
        legendDiv.innerHTML = displayedBassins.size > 0 ? html : '<strong>Bassins de Production</strong><br>Aucun à afficher.';
    }

    init();
</script>
</body>
</html>